## 简介

网关服务。技术基于Zuul；

![结构图](img/README/clip_image001.png)

1、UAA认证服务负责认证授权，发放token。 

2、所有请求经过网关到达微服务。

3、网关负责鉴权客户端以及请求转发。客户端携带着token访问由网关拦截到，然后对token进行信息，获得授权的信息，网关对客户端的权限进行校验，客户端的权限就是Token中的scope，还需要校验的有：客户端Id,客户端密钥等。

4、网关将token解析后传给微服务，微服务进行授权。详细流程是：网关校验通过以后，网关将token解析为明文，发送给各微服务那么各微服务就不必再解析了，只需要将token明文放到Spring Security的上下文中，那么在微服务中就可以随意使用了。

如果网关想要把请求信息转发给各微服务，那么各微服务就需要在注册中心中注册，所以可以把网关看成是一个资源服务，它对请求进行鉴权等。

**实现：**

- 依赖：引入注册中心依赖、网关依赖；

- 配置文件：配置网关所需要的依赖；

- token配置：token配置和其他资源服务的配置相同，就是配置JWT的解析：tokenStore（）

- 资源服务配置：将网关后面的资源服务配置到网关里。在ResouceServerConfig中定义资源服务配置，主要配置的内容就是定义一些匹配规则，描述某个接入客户端需要什么样的权限才能访问某个微服务。定义的方式有多种内部类或者实体类等，这里是对于一个资源服务在这个ResouceServerConfig.java中以内部类的方式配置。

  授权服务也是被看成一种资源服务，不过它是对访问请求的限制更小。在网关下配置该服务。

  配置的思路是：参考springcloud_order2中的资源服务配置，配置了两个方法configure()方法，一个是用来解析token的，一个是用来匹配服务的；

- 安全配置：配置Spring Security的基本安全拦截服务；
- 使用Zuul的过滤器，实现将token解析为明文发送给相应的资源微服务。



**待改进**

- 注册中心应改进为nacos;
- 网关改进为Spring Cloud gateway；

**体会**

实现的是由网关进行鉴权，解析客户端请求的JWT，然后将解析后的JWT包装为token发送给对应的微服务。可以发现这个过程中，需要网关解析JWT为键值对，然后将键值对封装为JSON－token，然后编码发送给对应的微服务，微服务收到后，解编码将这个token转为Spring Security使用的token对象，然后保存到Spring Securiy。过程很麻烦,因为网关对JWT进行解析，然后在打包为token发给资源服务，资源服务还要在解析token。

不如先前在项目springcloud_uaa2和springcloud_order2里使用的，**直接由资源服务解析JWT更方便**，**网关只负责服务调用**，对客户端的请求进行分发，这样更好。

